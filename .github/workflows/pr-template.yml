name: PR Template Check

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-template:
    name: Validate PR Template
    runs-on: ubuntu-latest
    steps:
      - name: Check PR body
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const errors = [];

            // Required sections
            const required = [
              { section: '## Summary', msg: 'Missing ## Summary section' },
              { section: '## Changes', msg: 'Missing ## Changes section' },
              { section: '## Testing', msg: 'Missing ## Testing section' },
              { section: '## Classification', msg: 'Missing ## Classification section' },
            ];

            for (const { section, msg } of required) {
              if (!body.includes(section)) {
                errors.push(msg);
              }
            }

            // Must reference an issue
            if (!body.match(/Closes #\d+/i) && !body.match(/Fixes #\d+/i) && !body.match(/Ref #\d+/i)) {
              errors.push('Must reference an issue (Closes #N, Fixes #N, or Ref #N)');
            }

            // Summary must not be the template placeholder
            const summaryMatch = body.match(/## Summary\s*\n([\s\S]*?)(?=\n##|$)/);
            if (summaryMatch) {
              const summaryContent = summaryMatch[1].replace(/<!--.*?-->/gs, '').trim();
              if (!summaryContent || summaryContent === 'Closes #') {
                errors.push('Summary section is empty — describe what this PR does');
              }
            }

            // At least one classification checked
            const classificationMatch = body.match(/## Classification\s*\n([\s\S]*?)$/);
            if (classificationMatch) {
              if (!classificationMatch[1].includes('[x]')) {
                errors.push('Must check at least one Classification checkbox');
              }
            }

            // At least one test checkbox checked
            const testingMatch = body.match(/## Testing\s*\n([\s\S]*?)(?=\n##|$)/);
            if (testingMatch) {
              if (!testingMatch[1].includes('[x]')) {
                errors.push('Must check at least one Testing checkbox (cargo test passes?)');
              }
            }

            if (errors.length > 0) {
              const message = '## ❌ PR Template Validation Failed\n\n' +
                errors.map(e => `- ${e}`).join('\n') +
                '\n\nPlease fill out all required sections of the PR template.';
              
              core.setFailed(message);
              
              // Post comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: message
              });
            } else {
              console.log('✅ PR template validation passed');
            }
