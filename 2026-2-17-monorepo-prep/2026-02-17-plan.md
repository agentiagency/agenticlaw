# Rustclaw Metacognition Integration Plan

## Status
Plan drafted, user said "not exactly" to the proposed approach. Needs discussion before implementation.

## Repository
- Remote: https://github.com/thomcom/agentiagency.git
- Branch: ws2-3-agency
- Worktree: /home/devkit/worktrees/ws2-3-agency/agenticlaw
- Last commit: fc4a2b6 (+ fix commits after)
- Tree: clean

## What Exists
Rustclaw is a complete Rust agent runtime with:
- Vim TUI chat (`agenticlaw`)
- .ctx file persistence (datetime-prefixed)
- 6 modular tools (bash, read, write, edit, glob, grep)
- Anthropic SSE streaming to Claude Opus 4.6
- Session resume (`agenticlaw -r`)
- Web portal (`agenticlaw gateway`)
- 211+ tests, zero warnings

## What's Missing (Metacognition Gaps)

### 1. Context discovery too narrow
**Current**: Only loads SOUL.md and AGENTS.md
**Needed**: META_COGNITION.md, CLAUDE.md, VISION.md, EGO.md, PURPOSE.md
**File**: `crates/agenticlaw-agent/src/ctx_file.rs` line 114

### 2. Decision algorithm not in system prompt
**Current**: No meta-cognitive guidance injected
**Needed**: The core pattern (falsifiable op → sequence → decompose) from META_COGNITION.md
**File**: `crates/agenticlaw-agent/src/runtime.rs` line 105-112

### 3. No workspace state persistence
**Current**: Each session starts fresh
**Needed**: .agenticlaw/STATE.md read on start, written on exit
**File**: `crates/agenticlaw-agent/src/ctx_file.rs` (new functions), `crates/agenticlaw-gateway/src/tui.rs` (exit handler)

### 4. Tool prompts not wired
**Current**: `ToolRegistry::combined_prompts()` exists but is never called
**Needed**: Inject into system prompt in runtime.rs
**File**: `crates/agenticlaw-agent/src/runtime.rs` line 110

### 5. .ctx is parallel record, not wire source
**Current**: Runtime builds jsonl from Vec<LlmMessage> in memory, .ctx is written alongside
**Needed**: .ctx should be the single source, JIT-transformed to jsonl for API calls
**File**: Architectural change across session.rs and runtime.rs

## Proposed Approach (Draft — Needs User Input)

Tiered context loading:
- Tier 1 (every request): SOUL.md, META_COGNITION.md, decision algorithm
- Tier 2 (system prompt): AGENTS.md, CLAUDE.md, VISION.md, STATE.md
- Tier 3 (first turn only): EGO.md, PURPOSE.md

User rejected this with "not exactly" — likely wants a different architecture. Ask before implementing.

## Key Files to Modify
- `crates/agenticlaw-agent/src/ctx_file.rs` — context discovery
- `crates/agenticlaw-agent/src/session.rs` — session creation with context
- `crates/agenticlaw-agent/src/runtime.rs` — system prompt construction
- `crates/agenticlaw-gateway/src/tui.rs` — state persistence on exit

## How to Resume
```bash
cd /home/devkit/worktrees/ws2-3-agency/agenticlaw
# Read these checkpoint files:
cat .agenticlaw/sessions/2026-2-17-monorepo-prep/2026-02-17-what-it-is.sh
cat .agenticlaw/sessions/2026-2-17-monorepo-prep/2026-02-17-plan.md
cat .agenticlaw/sessions/2026-2-17-monorepo-prep/20260217-status.ctx
cat .agenticlaw/sessions/2026-2-17-monorepo-prep/20260217-frontier.ctx
# Then discuss metacognition approach with user before implementing
```
